name: Build and Release

on:
  push:
    tags:
      - 'v*'
  schedule:
    # Run at 2 AM UTC daily
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: false
        type: choice
        default: 'nightly'
        options:
          - nightly
          - release

permissions:
  contents: write
  packages: write

jobs:
  determine-build-type:
    runs-on: ubuntu-latest
    outputs:
      is_release: ${{ steps.check.outputs.is_release }}
      is_nightly: ${{ steps.check.outputs.is_nightly }}

    steps:
      - name: Determine build type
        id: check
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/tags/v"* ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "is_nightly=false" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.release_type }}" == "release" ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "is_nightly=false" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "is_nightly=true" >> $GITHUB_OUTPUT
          fi

  check-nightly-changes:
    runs-on: ubuntu-latest
    needs: [determine-build-type]
    if: needs.determine-build-type.outputs.is_nightly == 'true'
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
      nightly_version: ${{ steps.get_version.outputs.nightly_version || steps.set_empty_version.outputs.nightly_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes since last nightly
        id: check_changes
        run: |
          # Get the latest nightly tag
          LATEST_NIGHTLY=$(git tag -l "*-nightly-*" | sort -V | tail -n 1)

          if [ -z "$LATEST_NIGHTLY" ]; then
            echo "No previous nightly found, proceeding with build"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            # Check if there are commits since the last nightly tag
            COMMITS_SINCE=$(git rev-list "${LATEST_NIGHTLY}"..HEAD --count)

            if [ "$COMMITS_SINCE" -gt 0 ]; then
              echo "Found $COMMITS_SINCE commits since last nightly"
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              echo "No changes since last nightly"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Extract version from Cargo.toml
        if: steps.check_changes.outputs.has_changes == 'true'
        id: get_version
        run: |
          VERSION=$(grep -m1 '^version = ' Cargo.toml | cut -d'"' -f2)
          DATE=$(date +%Y%m%d)
          NIGHTLY_VERSION="${VERSION}-nightly-${DATE}"
          echo "nightly_version=$NIGHTLY_VERSION" >> $GITHUB_OUTPUT
          echo "Nightly version will be: $NIGHTLY_VERSION"

      - name: Set empty nightly_version when no changes
        if: steps.check_changes.outputs.has_changes != 'true'
        id: set_empty_version
        run: |
          echo "nightly_version=" >> $GITHUB_OUTPUT

  build-and-push:
    runs-on: ubuntu-latest
    needs: [determine-build-type, check-nightly-changes]
    if: |
      always() &&
      (needs.determine-build-type.outputs.is_release == 'true' ||
       (needs.determine-build-type.outputs.is_nightly == 'true' && needs.check-nightly-changes.outputs.has_changes == 'true'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ needs.determine-build-type.outputs.is_release == 'true' && '0' || '1' }}

      # QEMU enables building for multiple CPU architectures (arm64, amd64, etc.)
      # Required for cross-platform Docker image builds
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Release-specific: Extract metadata for Docker tags
      - name: Extract metadata (tags, labels) for Docker
        if: needs.determine-build-type.outputs.is_release == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      # Release build: Use metadata action tags
      - name: Build and push Docker image (Release)
        if: needs.determine-build-type.outputs.is_release == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Nightly build: Use nightly-specific tags
      - name: Build and push Docker image (Nightly)
        if: needs.determine-build-type.outputs.is_nightly == 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ needs.check-nightly-changes.outputs.nightly_version }}
            ghcr.io/${{ github.repository }}:nightly
          labels: |
            org.opencontainers.image.version=${{ needs.check-nightly-changes.outputs.nightly_version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Release-specific: Create GitHub Release
      - name: Create GitHub Release
        if: needs.determine-build-type.outputs.is_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          body: |
            ## Docker Image

            Pull the image with:
            ```bash
            docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}
            ```

            Or use the latest tag:
            ```bash
            docker pull ghcr.io/${{ github.repository }}:latest
            ```

            ## Usage

            See the repository README for usage instructions and docker-compose examples.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Nightly-specific: Create nightly tag
      - name: Create nightly tag
        if: needs.determine-build-type.outputs.is_nightly == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.check-nightly-changes.outputs.nightly_version }}" -m "Nightly release ${{ needs.check-nightly-changes.outputs.nightly_version }}"
          git push origin "${{ needs.check-nightly-changes.outputs.nightly_version }}"
